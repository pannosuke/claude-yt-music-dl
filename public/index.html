<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Tools - Download & Organize</title>

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/shared.css">
    <link rel="stylesheet" href="/css/downloader.css">
    <link rel="stylesheet" href="/css/organizer.css">
    <link rel="stylesheet" href="/css/upgrader.css">
</head>
<body>
    <div class="app-container">
        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-button" data-route="downloader" onclick="router.navigate('downloader')">
                <span class="tab-icon">‚¨áÔ∏è</span>
                <span class="tab-label">YouTube Downloader</span>
            </button>
            <button class="tab-button" data-route="organizer" onclick="router.navigate('organizer')">
                <span class="tab-icon">üìÅ</span>
                <span class="tab-label">Music Organizer</span>
            </button>
            <button class="tab-button" data-route="upgrader" onclick="router.navigate('upgrader')">
                <span class="tab-icon">üéµ</span>
                <span class="tab-label">Quality Upgrader</span>
            </button>
        </nav>

        <!-- Module 1: YouTube Music Downloader -->
        <div id="module-downloader" class="module-container">
            <h1>YouTube Music Downloader</h1>
            <p class="subtitle">Download playlists in FLAC format, organized by artist and album</p>

            <div class="info-box">
                <strong>Requirements:</strong> Make sure <code>yt-dlp</code> is installed on your system.<br>
                Install with: <code>pip install yt-dlp</code>
            </div>

            <form id="downloadForm">
                <div class="form-group">
                    <label for="playlistUrl">YouTube Music Playlist URL *</label>
                    <input
                        type="text"
                        id="playlistUrl"
                        name="playlistUrl"
                        value=""
                        placeholder="https://music.youtube.com/playlist?list=..."
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="outputPath">Output Directory Path *</label>
                    <input
                        type="text"
                        id="outputPath"
                        name="outputPath"
                        value=""
                        placeholder="/path/to/music/directory"
                        required
                    >
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        Enter the full path where you want to save the music files
                    </small>
                </div>

                <div class="form-group">
                    <label for="cookiesPath">Cookies File Path</label>
                    <input
                        type="text"
                        id="cookiesPath"
                        name="cookiesPath"
                        value=""
                        placeholder="/path/to/cookies.txt (optional)"
                    >
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        Path to your cookies.txt file for authentication
                    </small>
                </div>

                <div class="form-group">
                    <label for="poToken">PO Token</label>
                    <input
                        type="text"
                        id="poToken"
                        name="poToken"
                        value=""
                        placeholder="Your PO token (optional)"
                    >
                </div>

                <div class="button-group">
                    <button type="submit" id="downloadBtn">Start Download</button>
                    <button type="button" id="cancelBtn" class="button-cancel" style="display: none;">Cancel Download</button>
                </div>
            </form>

            <div class="progress-container" id="progressContainer">
                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="label">Total Tracks</div>
                        <div class="value" id="totalTracks">--</div>
                    </div>
                    <div class="stat-card completed">
                        <div class="label">Completed</div>
                        <div class="value" id="completedTracks">0</div>
                    </div>
                    <div class="stat-card remaining">
                        <div class="label">Remaining</div>
                        <div class="value" id="remainingTracks">--</div>
                    </div>
                    <div class="stat-card failed">
                        <div class="label">Failed</div>
                        <div class="value" id="failedTracks">0</div>
                    </div>
                </div>

                <!-- Current Track Card -->
                <div class="current-track-card" id="currentTrackCard">
                    <h3>Currently Downloading</h3>
                    <div class="track-info">
                        <div class="track-info-row">
                            <span class="track-info-label">Artist:</span>
                            <span class="track-info-value" id="currentArtist">--</span>
                        </div>
                        <div class="track-info-row">
                            <span class="track-info-label">Album:</span>
                            <span class="track-info-value" id="currentAlbum">--</span>
                        </div>
                        <div class="track-title" id="currentTitle">Initializing...</div>
                        <div style="margin-top: 10px;">
                            <span class="format-badge" id="formatBadge">FLAC</span>
                        </div>
                    </div>
                    <div class="file-progress-bar-bg">
                        <div class="file-progress-bar" id="fileProgressBar"></div>
                    </div>
                </div>

                <!-- Errors Panel -->
                <div class="errors-panel" id="errorsPanel">
                    <h4 onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ‚ö†Ô∏è Issues Detected (Click to expand)
                    </h4>
                    <div class="error-list" id="errorList" style="display: none;"></div>
                </div>

                <!-- Overall Progress -->
                <div class="overall-progress-section">
                    <h3>Overall Progress</h3>
                    <div class="progress-text" id="progressText">Initializing...</div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <!-- Debug Log -->
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>

        <!-- Module 2: Music Library Organizer -->
        <div id="module-organizer" class="module-container">
            <h1>Music Library Organizer</h1>
            <p class="subtitle">Organize your music library for optimal Plex Media Server compatibility</p>

            <div class="info-box">
                <strong>What this does:</strong> Scans your music folder, identifies incorrect organization,
                and renames/moves files to match Plex standards using MusicBrainz database.<br>
                <strong>Supports:</strong> Western and Japanese music databases
            </div>

            <!-- STEP 1: Scan Library -->
            <div id="workflow-scan" class="workflow-section active">
                <div class="section-collapse-header">
                    <div class="header-left">
                        <div class="step-indicator">1</div>
                        <div class="header-title">
                            <h2>üìÇ Scan Library</h2>
                            <p class="subtitle">Select your music folder to analyze</p>
                        </div>
                    </div>
                    <div class="collapse-icon">‚ñº</div>
                </div>
                <div class="section-collapse-body">
                    <!-- Scan Form -->
                    <form id="scanForm">
                <div class="form-group">
                    <label for="musicPath">Music Library Path *</label>
                    <input
                        type="text"
                        id="musicPath"
                        name="musicPath"
                        value=""
                        placeholder="e.g., /Users/yourname/Music or C:\Users\yourname\Music"
                        required
                    >
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        üí° Tip: You can drag a folder from Finder/Explorer into this field, or copy/paste the path
                    </small>
                </div>

                <div class="button-group">
                    <button type="submit" id="scanBtn">Scan Library</button>
                    <button type="button" id="cancelScanBtn" class="button-cancel" style="display: none;">Cancel Scan</button>
                </div>
            </form>
                </div>
            </div>

            <!-- STEP 2: Scan Results & Deep Scan -->
            <div id="workflow-results" class="workflow-section pending">
                <div class="section-collapse-header">
                    <div class="header-left">
                        <div class="step-indicator">2</div>
                        <div class="header-title">
                            <h2>üìä Scan Results</h2>
                            <p class="subtitle">Review scan results and run deep scan</p>
                        </div>
                    </div>
                    <div class="collapse-icon">‚ñº</div>
                </div>
                <div class="section-collapse-body">
                    <!-- Progress Container (shared for structure scan and deep scan) -->
                    <div class="progress-container" id="scanProgressContainer">
                        <div class="progress-text" id="scanProgressText">Initializing scan...</div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="scanProgressBar"></div>
                        </div>
                        <div class="log-container" id="scanLogContainer"></div>
                    </div>

            <!-- Scan Results -->
            <div class="scan-results" id="scanResults">
                <div class="results-header">
                    <h2>Scan Results</h2>
                    <div class="result-actions">
                        <button type="button" id="clearCacheBtn" style="background-color: #e74c3c; margin-right: 10px;">Clear Cache & Reset</button>
                        <button type="button" id="newScanBtn">New Scan</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-grid">
                    <div class="summary-card total">
                        <div class="label">Total Files</div>
                        <div class="value" id="summaryTotalFiles">--</div>
                    </div>
                    <div class="summary-card compliant">
                        <div class="label">Plex Compliant</div>
                        <div class="value" id="summaryCompliantFiles">--</div>
                    </div>
                    <div class="summary-card needs-fix">
                        <div class="label">Needs Fix</div>
                        <div class="value" id="summaryNeedsFix">--</div>
                    </div>
                    <div class="summary-card artists">
                        <div class="label">Artists</div>
                        <div class="value" id="summaryArtists">--</div>
                    </div>
                    <div class="summary-card albums">
                        <div class="label">Albums</div>
                        <div class="value" id="summaryAlbums">--</div>
                    </div>
                </div>

                <!-- Issues Breakdown -->
                <div class="issues-breakdown" id="issuesBreakdown" style="display: none;">
                    <h4>Issues Found</h4>
                    <div id="issuesList"></div>
                </div>

                <!-- Format Distribution -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">Audio Formats</h3>
                    <div class="format-list" id="formatList"></div>
                </div>

                <!-- Alphabetical Groups -->
                <div class="artist-groups" id="artistGroups">
                    <h3>Artists Grouped Alphabetically</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Click letter groups to select them for deep scanning
                    </p>
                    <div class="group-grid" id="groupGrid"></div>

                    <!-- Deep Scan Buttons -->
                    <div class="button-group" style="margin-top: 20px; display: none;" id="deepScanButtons">
                        <button type="button" id="deepScanSelectedBtn" class="button-primary" style="display: none;">
                            Deep Scan Selected
                        </button>
                        <button type="button" id="deepScanAllBtn" class="button-secondary" style="display: none;">
                            Deep Scan All
                        </button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- STEP 3: Plex Integration -->
            <div id="workflow-plex" class="workflow-section pending">
                <div class="section-collapse-header">
                    <div class="header-left">
                        <div class="step-indicator">3</div>
                        <div class="header-title">
                            <h2>üé¨ Plex Media Server Integration</h2>
                            <p class="subtitle">Compare offline library with Plex to prevent duplicates</p>
                        </div>
                    </div>
                    <div class="collapse-icon">‚ñº</div>
                </div>
                <div class="section-collapse-body">
            <!-- Plex Integration Section -->
            <div class="plex-section" id="plexSection">

                <!-- Plex Connection Settings -->
                <div class="plex-connection-panel">
                    <h3>Plex Server Connection</h3>
                    <form id="plexConnectForm">
                        <div class="form-group">
                            <label for="plexServerIp">Server IP Address *</label>
                            <input
                                type="text"
                                id="plexServerIp"
                                name="plexServerIp"
                                value=""
                                placeholder="192.168.1.100 or plex.local"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="plexPort">Port *</label>
                            <input
                                type="text"
                                id="plexPort"
                                name="plexPort"
                                value="32400"
                                placeholder="32400"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="plexToken">X-Plex-Token *</label>
                            <input
                                type="password"
                                id="plexToken"
                                name="plexToken"
                                value=""
                                placeholder="Your Plex authentication token"
                                required
                            >
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                Find your token: Settings ‚Üí Account ‚Üí Authorized Devices ‚Üí Show XML ‚Üí Copy the "token" value
                            </small>
                        </div>

                        <div class="button-group">
                            <button type="submit" id="plexConnectBtn">Test Connection</button>
                        </div>
                    </form>

                    <div class="connection-status" id="connectionStatus" style="display: none;"></div>
                </div>

                <!-- Plex Library Selection -->
                <div class="plex-library-panel" id="plexLibraryPanel" style="display: none;">
                    <h3>Select Music Library</h3>
                    <div id="libraryList" class="library-list"></div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="fetchLibraryBtn" style="display: none;">Fetch Library Tracks</button>
                    </div>
                </div>

                <!-- Plex Fetch Progress -->
                <div class="plex-progress-container" id="plexProgressContainer" style="display: none;">
                    <h3>Fetching Plex Library</h3>
                    <div class="progress-text" id="plexProgressText">Initializing...</div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="plexProgressBar"></div>
                    </div>
                </div>

                <!-- Comparison Results -->
                <div class="comparison-results" id="comparisonResults" style="display: none;">
                    <h3>Comparison Results</h3>

                    <!-- Summary Statistics -->
                    <div class="comparison-stats-grid">
                        <div class="comparison-stat-card safe">
                            <div class="label">Safe to Add</div>
                            <div class="value" id="statSafeToAdd">0</div>
                            <div class="desc">New tracks not in Plex</div>
                        </div>
                        <div class="comparison-stat-card upgrade">
                            <div class="label">Quality Upgrades</div>
                            <div class="value" id="statUpgrades">0</div>
                            <div class="desc">Better quality than Plex</div>
                        </div>
                        <div class="comparison-stat-card downgrade">
                            <div class="label">Quality Downgrades</div>
                            <div class="value" id="statDowngrades">0</div>
                            <div class="desc">Worse quality than Plex</div>
                        </div>
                        <div class="comparison-stat-card duplicate">
                            <div class="label">Same Quality Duplicates</div>
                            <div class="value" id="statDuplicates">0</div>
                            <div class="desc">Already in Plex (same quality)</div>
                        </div>
                    </div>

                    <!-- Detailed Conflicts Table -->
                    <div class="conflicts-panel">
                        <h4>Detailed Track Analysis</h4>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="SAFE_TO_ADD">Safe to Add</button>
                            <button class="filter-btn" data-filter="QUALITY_UPGRADE">Upgrades</button>
                            <button class="filter-btn" data-filter="QUALITY_DOWNGRADE">Downgrades</button>
                            <button class="filter-btn" data-filter="SAME_QUALITY_DUPLICATE">Duplicates</button>
                        </div>
                        <div class="conflicts-table-container">
                            <table class="conflicts-table" id="conflictsTable">
                                <thead>
                                    <tr>
                                        <th>Artist</th>
                                        <th>Album</th>
                                        <th>Title</th>
                                        <th>Offline Quality</th>
                                        <th>Plex Quality</th>
                                        <th>Status</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody id="conflictsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="exportReportBtn">Export Report (CSV)</button>
                        <button type="button" id="newComparisonBtn">New Comparison</button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- STEP 4: Auto-Match & Rename -->
            <div id="workflow-matcher" class="workflow-section pending">
                <div class="section-collapse-header">
                    <div class="header-left">
                        <div class="step-indicator">4</div>
                        <div class="header-title">
                            <h2>üîÑ Auto-Match & Rename Engine</h2>
                            <p class="subtitle">Match files to MusicBrainz and rename to Plex standards</p>
                        </div>
                    </div>
                    <div class="collapse-icon">‚ñº</div>
                </div>
                <div class="section-collapse-body">
            <!-- Auto-Match & Rename Section (Phase 3.5) -->
            <div id="matcherSection" class="results-section">

                <!-- Three-Phase Match Controls -->
                <div class="card">
                    <h3>Step 1: Three-Phase MusicBrainz Matching</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                        Match files in three phases: Artists ‚Üí Albums ‚Üí Tracks. Fix errors at each level before proceeding.
                    </p>
                    <div class="button-group">
                        <!-- Phase 1: Match Artists -->
                        <button type="button" id="matchArtistsBtn" class="button-primary">
                            Phase 1: Match Artists
                        </button>
                        <!-- Phase 1.5: Rename Artist Folders (appears after Phase 1) -->
                        <button type="button" id="renameArtistFoldersBtn" class="button-primary" style="display: none;">
                            üìÅ Rename Artist Folders
                        </button>
                        <!-- Phase 2: Match Albums -->
                        <button type="button" id="matchAlbumsBtn" class="button-secondary" disabled>
                            Phase 2: Match Albums
                        </button>
                        <!-- Phase 2.5: Rename Album Folders (appears after Phase 2) -->
                        <button type="button" id="renameAlbumFoldersBtn" class="button-primary" style="display: none;">
                            üìÇ Rename Album Folders & Update Metadata
                        </button>
                        <button type="button" id="cancelMatchBtn" class="button-danger" style="display: none;">
                            Cancel
                        </button>
                    </div>

                    <!-- Legacy: Keep old batch match button for backwards compatibility (hidden by default) -->
                    <div style="margin-top: 15px; display: none;" id="legacyMatchContainer">
                        <button type="button" id="startBatchMatchBtn" class="button-secondary">
                            Legacy: Single-Phase Match
                        </button>
                        <button type="button" id="cancelBatchMatchBtn" class="button-danger" style="display: none;">
                            Cancel
                        </button>
                    </div>

                    <!-- Match Progress -->
                    <div id="matchProgressContainer" style="display: none; margin-top: 20px;">
                        <div class="progress-text" id="matchProgressText">Initializing...</div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="matchProgressBar"></div>
                        </div>
                    </div>

                    <!-- Match Statistics -->
                    <div id="matchStatsContainer" style="display: none; margin-top: 20px;">
                        <div class="comparison-stats-grid">
                            <div class="comparison-stat-card safe">
                                <div class="label">Auto-Approved (‚â•90%)</div>
                                <div class="value" id="statAutoApprove">0</div>
                                <div class="desc">High confidence matches</div>
                            </div>
                            <div class="comparison-stat-card upgrade">
                                <div class="label">Review Required (70-89%)</div>
                                <div class="value" id="statReview">0</div>
                                <div class="desc">Medium confidence matches</div>
                            </div>
                            <div class="comparison-stat-card downgrade">
                                <div class="label">Manual Search (<70%)</div>
                                <div class="value" id="statManual">0</div>
                                <div class="desc">Low confidence matches</div>
                            </div>
                            <div class="comparison-stat-card duplicate">
                                <div class="label">Skipped/Errors</div>
                                <div class="value" id="statSkipped">0</div>
                                <div class="desc">No match or missing data</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Artist Folder Rename Preview -->
                <div id="artistRenamePreviewContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Preview Artist Folder Renames</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                        Review the proposed artist folder renames. Only folders with corrected names will be renamed.
                    </p>
                    <div id="artistRenamePreviewList" class="rename-preview-list"></div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="executeArtistRenamesBtn" class="button-primary">
                            ‚úÖ Execute Artist Renames
                        </button>
                        <button type="button" id="cancelArtistRenamesBtn" class="button-secondary">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Album Folder Rename Preview -->
                <div id="albumRenamePreviewContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Preview Album Folder Renames</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                        Review the proposed album folder renames. Only folders with corrected names will be renamed, and metadata will be updated.
                    </p>
                    <div id="albumRenamePreviewList" class="rename-preview-list"></div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="executeAlbumRenamesBtn" class="button-primary">
                            ‚úÖ Execute Album Renames
                        </button>
                        <button type="button" id="cancelAlbumRenamesBtn" class="button-secondary">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Match Results Review -->
                <div id="matchResultsContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Step 2: Review Match Results</h3>
                    <div class="filter-buttons" style="margin-bottom: 15px;">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="auto_approve">Auto-Approved</button>
                        <button class="filter-btn" data-filter="review">Review Required</button>
                        <button class="filter-btn" data-filter="manual">Manual Search</button>
                        <button class="filter-btn" data-filter="skipped">Skipped</button>
                    </div>

                    <div id="matchResultsList" class="match-results-list"></div>
                </div>

                <!-- Step 2: Preview Renames -->
                <div id="outputDirectoryContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Step 2: Preview Rename Plan</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                        Files will be renamed and reorganized in-place within your scanned directory. The new structure will follow Plex Media Server standards: <code>{Artist}/{Album (Year)}/{Track#} - {Title}.ext</code>
                    </p>

                    <div class="info-box" style="margin-bottom: 20px;">
                        <strong>‚ö†Ô∏è Important:</strong> Files will be renamed in-place within your current music directory. Make sure you have a backup if this is your only copy!
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="previewRenamesBtn" class="button-primary">
                            Preview Renames ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Rename Preview -->
                <div id="renamePreviewContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Step 3: Preview & Execute Renames</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                        Review the proposed file renames. Run a dry-run first to verify changes before applying.
                    </p>

                    <div id="renamePreviewList" class="rename-preview-list"></div>

                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" id="cleanupEmptyDirsCheckbox" checked style="margin-right: 10px; cursor: pointer; width: auto;">
                            <span>
                                <strong>Clean up empty directories after renaming</strong>
                                <div style="color: #64748b; font-size: 12px; margin-top: 4px;">
                                    Automatically remove empty folders left behind after moving files to new locations
                                </div>
                            </span>
                        </label>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="executeDryRunBtn" class="button-secondary">
                            üîç Execute Rename (Dry-Run)
                        </button>
                        <button type="button" id="executeRenameBtn" class="button-primary">
                            ‚úÖ Execute Rename (Apply Changes)
                        </button>
                    </div>

                    <!-- Rename Progress -->
                    <div id="renameProgressContainer" style="display: none; margin-top: 20px;">
                        <div class="progress-text" id="renameProgressText">Initializing...</div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="renameProgressBar"></div>
                        </div>
                    </div>

                    <!-- Rename Results -->
                    <div id="renameResultsContainer" style="display: none; margin-top: 20px;">
                        <h4>Rename Results</h4>
                        <div id="renameResultsList" class="rename-results-list"></div>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- STEP 5: Move to Live Library -->
            <div id="workflow-move" class="workflow-section pending">
                <div class="section-collapse-header">
                    <div class="header-left">
                        <div class="step-indicator">5</div>
                        <div class="header-title">
                            <h2>üì¶ Move to Live Plex Library</h2>
                            <p class="subtitle">Move organized files to live Plex Media Server</p>
                        </div>
                    </div>
                    <div class="collapse-icon">‚ñº</div>
                </div>
                <div class="section-collapse-body">
            <!-- Move to Live Plex Library Section (Phase 4) -->
            <div id="moveToLibrarySection" class="results-section">

                <!-- Configuration Panel -->
                <div class="card">
                    <h3>Live Library Configuration</h3>

                    <form id="liveLibraryForm">
                        <div class="form-group">
                            <label for="liveLibraryPath">Live Library Path *</label>
                            <input
                                type="text"
                                id="liveLibraryPath"
                                name="liveLibraryPath"
                                value=""
                                placeholder="/path/to/live/plex/library or C:\Plex\Music"
                                required
                                style="width: 100%; margin-bottom: 8px;"
                            >
                            <button type="button" id="fetchPlexPathBtn" class="button-secondary" style="white-space: nowrap; padding: 8px 16px; font-size: 13px; margin-bottom: 5px;">
                                üì° Get from Plex
                            </button>
                            <small style="color: #666; font-size: 12px; display: block;">
                                üí° Tip: Click "Get from Plex" to auto-fill, or manually enter the path
                            </small>
                            <div id="pathValidationStatus" class="connection-status" style="display: none; margin-top: 10px;"></div>
                        </div>

                        <div class="form-group">
                            <label>Operation Mode</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="moveMode" value="copy" checked style="margin-right: 8px;">
                                    <div>
                                        <strong>Copy</strong>
                                        <div style="font-size: 12px; color: #64748b;">Keep original files in staging</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="moveMode" value="move" style="margin-right: 8px;">
                                    <div>
                                        <strong>Move</strong>
                                        <div style="font-size: 12px; color: #64748b;">Delete from staging after move</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="button-group">
                            <button type="button" id="validatePathBtn" class="button-secondary">
                                Validate Path
                            </button>
                            <button type="button" id="planMoveBtn" class="button-primary">
                                üîç Plan Move (Dry-Run)
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Move Plan Preview -->
                <div id="movePlanContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Move Plan Preview</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                        Review what will happen when you execute the move. No files will be modified until you click "Execute Move".
                    </p>

                    <!-- Plan Summary Stats -->
                    <div class="comparison-stats-grid" style="margin-bottom: 20px;">
                        <div class="comparison-stat-card safe">
                            <div class="label">New Files</div>
                            <div class="value" id="planStatNewFiles">0</div>
                            <div class="desc">Not in Plex yet</div>
                        </div>
                        <div class="comparison-stat-card upgrade">
                            <div class="label">Quality Upgrades</div>
                            <div class="value" id="planStatUpgrades">0</div>
                            <div class="desc">Will replace lower quality</div>
                        </div>
                        <div class="comparison-stat-card downgrade">
                            <div class="label">Quality Downgrades</div>
                            <div class="value" id="planStatDowngrades">0</div>
                            <div class="desc">Will skip (lower quality)</div>
                        </div>
                        <div class="comparison-stat-card duplicate">
                            <div class="label">Same Quality</div>
                            <div class="value" id="planStatSameQuality">0</div>
                            <div class="desc">Will skip (duplicates)</div>
                        </div>
                    </div>

                    <!-- Detailed Plan Preview List -->
                    <div id="movePlanList" class="rename-preview-list"></div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="executeMoveBtn" class="button-primary">
                            ‚úÖ Execute Move
                        </button>
                        <button type="button" id="cancelPlanBtn" class="button-secondary">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Move Progress -->
                <div id="moveProgressContainer" style="display: none; margin-top: 20px;">
                    <h3>Move Progress</h3>
                    <div class="progress-text" id="moveProgressText">Initializing...</div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="moveProgressBar"></div>
                    </div>
                </div>

                <!-- Move Results -->
                <div id="moveResultsContainer" class="card" style="display: none; margin-top: 20px;">
                    <h3>Move Results</h3>
                    <div id="moveResultsList" class="rename-results-list"></div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" id="rollbackMoveBtn" class="button-danger">
                            ‚Ü©Ô∏è Rollback Last Move
                        </button>
                        <button type="button" id="triggerPlexRefreshBtn" class="button-secondary">
                            üîÑ Trigger Plex Refresh
                        </button>
                        <button type="button" id="newMoveBtn" class="button-primary">
                            New Move Operation
                        </button>
                    </div>
                </div>
            </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Module 3: Quality Upgrader -->
    <div id="module-upgrader" class="module-container">
        <h1>Quality Upgrader</h1>
        <p class="subtitle">Upgrade your 4-5 star rated tracks to FLAC quality from YouTube Music</p>

        <div class="main-content">
            <!-- Plex Settings -->
            <div class="card">
                <h2>Plex Settings</h2>
                <div class="form-group">
                    <label for="upgraderPlexServer">Plex Server IP:</label>
                    <input type="text" id="upgraderPlexServer" class="input-field" placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="upgraderPlexPort">Port:</label>
                    <input type="text" id="upgraderPlexPort" class="input-field" placeholder="32400" value="32400">
                </div>
                <div class="form-group">
                    <label for="upgraderPlexToken">Plex Token:</label>
                    <input type="password" id="upgraderPlexToken" class="input-field" placeholder="Enter your Plex token">
                </div>
                <button type="button" id="upgraderTestConnectionBtn" class="button-secondary">
                    üîå Test Connection
                </button>
                <div id="upgraderConnectionStatus" style="display: none; margin-top: 10px;"></div>
            </div>

            <!-- Library Selection -->
            <div id="upgraderLibraryContainer" class="card" style="display: none; margin-top: 20px;">
                <h2>Select Music Library</h2>
                <div id="upgraderLibraryList" class="library-list"></div>
            </div>

            <!-- Rating & Fetch Settings -->
            <div id="upgraderSettingsContainer" class="card" style="display: none; margin-top: 20px;">
                <h2>Settings</h2>
                <div class="form-group">
                    <label for="upgradeMinRating">Minimum Rating:</label>
                    <select id="upgradeMinRating" class="input-field">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars only)</option>
                        <option value="4" selected>‚≠ê‚≠ê‚≠ê‚≠ê (4-5 stars)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3-5 stars)</option>
                    </select>
                </div>
                <button type="button" id="fetchRatedTracksBtn" class="button-primary">
                    üéµ Fetch Rated Tracks from Plex
                </button>
            </div>

            <!-- Fetch Progress -->
            <div id="upgradeRatedProgressContainer" style="display: none; margin-top: 20px;">
                <div class="progress-text" id="upgradeRatedProgressText">Fetching rated tracks...</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="upgradeRatedProgressBar"></div>
                </div>
            </div>

            <!-- Rated Tracks Summary -->
            <div id="upgradeSummaryContainer" class="card" style="display: none; margin-top: 20px;">
                <h2>Rated Tracks Summary</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Total Rated Tracks</div>
                        <div class="value" id="upgradeTotalRated">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Low Quality Candidates</div>
                        <div class="value" id="upgradeLowQualityCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Already Upgraded</div>
                        <div class="value" id="upgradeAlreadyCount">0</div>
                    </div>
                </div>
                <button type="button" id="detectUpgradesBtn" class="button-primary" style="margin-top: 15px;">
                    üîç Detect Upgrade Candidates
                </button>
            </div>

            <!-- Upgrade Candidates -->
            <div id="upgradeCandidatesContainer" class="card" style="display: none; margin-top: 20px;">
                <h2>üéß Upgrade Candidates</h2>
                <div style="margin-bottom: 15px;">
                    <button type="button" id="selectAllUpgradesBtn" class="button-secondary">
                        Select All
                    </button>
                    <button type="button" id="deselectAllUpgradesBtn" class="button-secondary">
                        Deselect All
                    </button>
                    <button type="button" id="scrollToBottomUpgradesBtn" class="button-secondary">
                        ‚¨áÔ∏è Scroll to Bottom
                    </button>
                </div>

                <div id="upgradeCandidatesList" class="upgrade-candidates-list"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button type="button" id="startBulkUpgradeBtn" class="button-primary">
                        ‚¨áÔ∏è Download & Upgrade Selected
                    </button>
                </div>
            </div>

            <!-- Upgrade Progress -->
            <div id="upgradeProgressContainer" style="display: none; margin-top: 20px;">
                <h2>Upgrade Progress</h2>
                <div class="progress-text" id="upgradeProgressText">Initializing...</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="upgradeProgressBar"></div>
                </div>
                <div style="margin-top: 10px;">
                    <strong>Status:</strong> <span id="upgradeCurrentTrack">-</span>
                </div>
                <div class="upgrade-stats" style="margin-top: 10px;">
                    <span>‚úÖ Completed: <strong id="upgradeCompletedCount">0</strong></span>
                    <span style="margin-left: 20px;">‚ö†Ô∏è Failed: <strong id="upgradeFailedCount">0</strong></span>
                    <span style="margin-left: 20px;">üîÑ In Progress: <strong id="upgradeInProgressCount">0</strong></span>
                </div>
            </div>

            <!-- Upgrade Results -->
            <div id="upgradeResultsContainer" class="card" style="display: none; margin-top: 20px;">
                <h2>Upgrade Results</h2>
                <div id="upgradeResultsList" class="rename-results-list"></div>
            </div>
        </div>
    </div>

    <!-- Manual Search Modal -->
    <div id="manualSearchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç Manual MusicBrainz Search</h2>
                <button class="modal-close" onclick="document.getElementById('manualSearchModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Search MusicBrainz to find the correct match for this track.</p>

                <div class="form-group">
                    <label for="searchArtist">Artist</label>
                    <input type="text" id="searchArtist" placeholder="Artist name">
                </div>

                <div class="form-group">
                    <label for="searchAlbum">Album <span class="optional">(optional)</span></label>
                    <input type="text" id="searchAlbum" placeholder="Album name">
                </div>

                <div class="form-group">
                    <label for="searchTitle">Title</label>
                    <input type="text" id="searchTitle" placeholder="Track title">
                </div>

                <button type="button" id="performSearchBtn" class="button-primary">Search MusicBrainz</button>

                <div id="searchResultsContainer" style="margin-top: 20px; display: none;">
                    <h3>Search Results</h3>
                    <div id="searchResultsList" class="search-results-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metadata Editor Modal -->
    <div id="metadataEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Metadata</h2>
                <button class="modal-close" onclick="document.getElementById('metadataEditorModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Manually enter the correct metadata for this track.</p>

                <div class="form-group">
                    <label for="editArtist">Artist</label>
                    <input type="text" id="editArtist" placeholder="Artist name" required>
                </div>

                <div class="form-group">
                    <label for="editAlbum">Album</label>
                    <input type="text" id="editAlbum" placeholder="Album name" required>
                </div>

                <div class="form-group">
                    <label for="editTitle">Title</label>
                    <input type="text" id="editTitle" placeholder="Track title" required>
                </div>

                <div class="form-group">
                    <label for="editYear">Year <span class="optional">(optional)</span></label>
                    <input type="text" id="editYear" placeholder="Year (e.g., 2024)">
                </div>

                <div class="form-group">
                    <label for="editTrack">Track Number <span class="optional">(optional)</span></label>
                    <input type="text" id="editTrack" placeholder="Track number">
                </div>

                <div class="button-group">
                    <button type="button" id="saveMetadataBtn" class="button-primary">Save Changes</button>
                    <button type="button" class="button-secondary" onclick="document.getElementById('metadataEditorModal').style.display='none'">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript modules -->
    <script src="/js/router.js"></script>
    <script src="/js/downloader.js"></script>
    <script src="/js/organizer.js"></script>
    <script src="/js/upgrader.js"></script>
</body>
</html>
